@model PreConHub.Models.ViewModels.PurchaserDashboardViewModel
@{
    ViewData["Title"] = "My Dashboard";
}

<div class="container py-4">
    <!-- Header -->
    <div class="mb-4">
        <h1 class="h3 mb-1">Welcome back, @Model.PurchaserName! ðŸ‘‹</h1>
        <p class="text-muted">Track your pre-construction purchase progress</p>
    </div>

    <!-- Success/Error Messages -->
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle me-2"></i>@TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Search & Pagination Controls -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body py-3">
            <form method="get" asp-action="Dashboard" id="filterForm">
                <div class="row g-2 align-items-end">
                    <div class="col-md-5">
                        <label class="form-label small text-muted mb-1">Search</label>
                        <div class="input-group input-group-sm">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text" name="search" id="searchBox" class="form-control"
                                   placeholder="Unit number or project name..."
                                   value="@Model.SearchQuery" />
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small text-muted mb-1">Per Page</label>
                        <select name="pageSize" class="form-select form-select-sm">
                            @foreach (var sz in new[] { 25, 50, 100, 250, 500 })
                            {
                                if (sz == Model.PageSize)
                                {
                                    <option value="@sz" selected>@sz per page</option>
                                }
                                else
                                {
                                    <option value="@sz">@sz per page</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="col-md-4 d-flex gap-2">
                        <button type="submit" class="btn btn-sm btn-primary">
                            <i class="bi bi-funnel me-1"></i>Apply
                        </button>
                        <a asp-action="Dashboard" class="btn btn-sm btn-outline-secondary">Clear</a>
                        <span class="text-muted small align-self-center ms-auto">
                            @if (Model.TotalFilteredUnits < Model.TotalUnits)
                            {
                                @:Showing @Model.TotalFilteredUnits of @Model.TotalUnits units
                            }
                            else
                            {
                                @:@Model.TotalUnits unit(s)
                            }
                        </span>
                    </div>
                </div>
                <input type="hidden" name="page" value="1" />
            </form>
        </div>
    </div>

    @if (Model.Units.Count == 0 && (!string.IsNullOrWhiteSpace(Model.SearchQuery)))
    {
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body text-center py-5">
                <i class="bi bi-search fs-1 text-muted mb-3 d-block"></i>
                <h5 class="text-muted">No Units Match Your Search</h5>
                <p class="text-muted">Try a different search term or clear the filter.</p>
                <a asp-action="Dashboard" class="btn btn-outline-primary">
                    <i class="bi bi-x-circle me-1"></i>Clear Search
                </a>
            </div>
        </div>
    }

    @foreach (var unit in Model.Units)
    {
        <div class="card border-0 shadow-sm mb-4">
            <!-- Unit Header -->
            <div class="card-header bg-white border-0 pb-0">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h4 class="mb-1">
                            <i class="bi bi-building text-primary me-2"></i>
                            Unit @unit.UnitNumber
                        </h4>
                        <p class="text-muted mb-0">@unit.ProjectName</p>
                        <small class="text-muted">@unit.ProjectAddress</small>
                    </div>
                    <div class="text-end">
                        @if (unit.ClosingDate.HasValue)
                        {
                            var daysLeft = unit.DaysUntilClosing;
                            var badgeClass = daysLeft > 90 ? "bg-success" : daysLeft > 30 ? "bg-warning text-dark" : "bg-danger";
                            <span class="badge @badgeClass fs-6">
                                @if (daysLeft > 0)
                                {
                                    @:@daysLeft days until closing
                                }
                                else
                                {
                                    @:Closing date passed
                                }
                            </span>
                            <div class="small text-muted mt-1">@unit.ClosingDate?.ToString("MMMM dd, yyyy")</div>
                        }
                    </div>
                </div>
            </div>

            <div class="card-body">
                <div class="row">
                    <!-- Left: Progress & Actions -->
                    <div class="col-lg-4 border-end">
                        <!-- Completion Progress -->
                        <h6 class="text-muted mb-3">YOUR PROGRESS</h6>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between small mb-1">
                                <span>Profile Completion</span>
                                <span class="fw-bold">@unit.CompletionPercentage%</span>
                            </div>
                            <div class="progress" style="height: 10px;">
                                <div class="progress-bar bg-success" style="width: @unit.CompletionPercentage%"></div>
                            </div>
                        </div>

                        <!-- Checklist -->
                        <div class="mb-4">
                            @foreach (var step in unit.CompletionSteps)
                            {
                                <div class="d-flex align-items-center mb-2">
                                    @if (step.IsComplete)
                                    {
                                        <i class="bi bi-check-circle-fill text-success me-2"></i>
                                        <span class="text-muted text-decoration-line-through">@step.Name</span>
                                    }
                                    else
                                    {
                                        <i class="bi bi-circle text-secondary me-2"></i>
                                        <span>@step.Name</span>
                                    }
                                </div>
                            }
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-grid gap-2">
                            @if (!unit.HasMortgageInfo)
                            {
                                <a href="@Url.Action("SubmitMortgageInfo", "Purchaser", new { id = unit.UnitId })" class="btn btn-primary">
                                    <i class="bi bi-bank me-2"></i>Submit Mortgage Info
                                </a>
                            }
                            else
                            {
                                <a href="@Url.Action("SubmitMortgageInfo", "Purchaser", new { id = unit.UnitId })" class="btn btn-outline-primary">
                                    <i class="bi bi-pencil me-2"></i>Update Mortgage Info
                                </a>
                            }

                            @if (!unit.HasFinancialsSubmitted)
                            {
                                <a href="@Url.Action("SubmitFinancials", "Purchaser", new { id = unit.UnitId })" class="btn btn-success">
                                    <i class="bi bi-wallet2 me-2"></i>Submit Financial Info
                                </a>
                            }
                            else
                            {
                                <a href="@Url.Action("SubmitFinancials", "Purchaser", new { id = unit.UnitId })" class="btn btn-outline-success">
                                    <i class="bi bi-pencil me-2"></i>Update Financial Info
                                </a>
                            }
                            <!-- Upload Documents Button -->
                            @if (!unit.HasDocumentsUploaded)

                            {
                                <a href="@Url.Action("ManageDocuments", "Purchaser", new { id = unit.UnitId })"
                                   class="btn btn-info text-white">
                                    <i class="bi bi-cloud-upload me-2"></i>Upload Documents
                                </a>
                            }

                            else

                            {
                                <a href="@Url.Action("ManageDocuments", "Purchaser", new { id = unit.UnitId })"
                                   class="btn btn-outline-info">
                                    <i class="bi bi-folder-check me-2"></i>Manage Documents
                                    <span class="badge bg-success ms-1">@unit.DocumentsUploadedCount</span>
                                </a>
                            }
                            @if (unit.HasSOA)
                            {
                                <a href="@Url.Action("ViewSOA", "Purchaser", new { id = unit.UnitId })" class="btn btn-outline-secondary">
                                    <i class="bi bi-file-text me-2"></i>View Statement of Adjustments
                                </a>
                                <a href="@Url.Action("DownloadSOA", "Purchaser", new { id = unit.UnitId })" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-download"></i> PDF
                                </a>
                            }
                            <hr class="my-2" />
                            <!-- Buyer's Lawyer -->
                            @if (unit.HasBuyerLawyer)
                            {
                                <div class="border rounded p-2 mb-2">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <small class="text-muted d-block">MY LAWYER</small>
                                            <strong>@unit.BuyerLawyerName</strong>
                                            @if (!string.IsNullOrEmpty(unit.BuyerLawyerFirm))
                                            {
                                                <small class="text-muted d-block">@unit.BuyerLawyerFirm</small>
                                            }
                                        </div>
                                        @if (unit.BuyerLawyerReviewStatus.HasValue)
                                        {
                                            var blStatusClass = unit.BuyerLawyerReviewStatus.Value switch
                                            {
                                                PreConHub.Models.Entities.LawyerReviewStatus.Pending => "warning",
                                                PreConHub.Models.Entities.LawyerReviewStatus.UnderReview => "info",
                                                PreConHub.Models.Entities.LawyerReviewStatus.Approved => "success",
                                                PreConHub.Models.Entities.LawyerReviewStatus.NeedsRevision => "danger",
                                                _ => "secondary"
                                            };
                                            <span class="badge bg-@blStatusClass">@unit.BuyerLawyerReviewStatus</span>
                                        }
                                    </div>
                                    <a href="@Url.Action("ViewMyLawyer", "Purchaser", new { id = unit.UnitId })"
                                       class="btn btn-sm btn-outline-primary mt-2 w-100">
                                        <i class="bi bi-eye me-1"></i>View Details
                                    </a>
                                </div>
                            }
                            else
                            {
                                <a href="@Url.Action("InviteLawyer", "Purchaser", new { id = unit.UnitId })"
                                   class="btn btn-outline-info btn-sm">
                                    <i class="bi bi-person-plus me-1"></i>Invite My Lawyer
                                </a>
                            }
                            <a href="@Url.Action("SubmitExtensionRequest", "Purchaser", new { id = unit.UnitId })"
                               class="btn btn-outline-warning btn-sm">
                                <i class="bi bi-calendar-range me-1"></i>Request Closing Extension
                                @if (unit.HasPendingExtension)
                                {
                                    <span class="badge bg-warning text-dark ms-1">Pending</span>
                                }
                            </a>
                        </div>
                    </div>

                    <!-- Middle: Financial Summary -->
                    <div class="col-lg-4 border-end">
                        <h6 class="text-muted mb-3">FINANCIAL SUMMARY</h6>
                        
                        <table class="table table-sm table-borderless">
                            <tr>
                                <td class="text-muted">Purchase Price</td>
                                <td class="text-end fw-bold">$@unit.PurchasePrice.ToString("N0")</td>
                            </tr>
                            <tr>
                                <td class="text-muted">Deposits Paid</td>
                                <td class="text-end text-success">$@unit.DepositsPaid.ToString("N0")</td>
                            </tr>
                            @if (unit.HasMortgageInfo && unit.MortgageApproved)
                            {
                                <tr>
                                    <td class="text-muted">Mortgage Approved</td>
                                    <td class="text-end">$@unit.MortgageAmount.ToString("N0")</td>
                                </tr>
                            }
                            @if (unit.HasFinancialsSubmitted && unit.AdditionalCashAvailable > 0)
                            {
                                <tr>
                                    <td class="text-muted">Additional Funds</td>
                                    <td class="text-end">$@unit.AdditionalCashAvailable.ToString("N0")</td>
                                </tr>
                            }
                            @if (unit.HasSOA)
                            {
                                <tr class="border-top">
                                    <td class="text-muted">Balance Due at Closing</td>
                                    <td class="text-end fw-bold">$@unit.BalanceDueOnClosing.ToString("N0")</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Cash Required to Close</td>
                                    <td class="text-end fw-bold text-primary">$@unit.CashRequiredToClose.ToString("N0")</td>
                                </tr>
                            }
                        </table>

                        @if (!unit.HasMortgageInfo)
                        {
                            <div class="alert alert-warning small">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                Please submit your mortgage information to see your complete financial picture.
                            </div>
                        }
                    </div>

                    <!-- Right: Status & Analysis -->
                    <div class="col-lg-4">
                        <h6 class="text-muted mb-3">CLOSING STATUS</h6>

                        @if (unit.HasSOA && unit.HasMortgageInfo)
                        {
                            <!-- Status Badge -->
                                var statusBadge = unit.Recommendation switch
                                {
                                    PreConHub.Models.Entities.ClosingRecommendation.ProceedToClose => ("bg-success", "Ready to Close", "bi-check-circle"),
                                    PreConHub.Models.Entities.ClosingRecommendation.CloseWithDiscount => ("bg-primary", "Eligible for Discount", "bi-tag"),
                                    PreConHub.Models.Entities.ClosingRecommendation.VTBSecondMortgage => ("bg-warning text-dark", "VTB Option Available", "bi-bank"),
                                    PreConHub.Models.Entities.ClosingRecommendation.VTBFirstMortgage => ("bg-orange", "VTB Required", "bi-bank2"),
                                    _ => ("bg-danger", "Action Required", "bi-exclamation-circle")
                                };
                            <div class="text-center mb-3">
                                <span class="badge @statusBadge.Item1 fs-6 p-2">
                                    <i class="bi @statusBadge.Item3 me-1"></i>@statusBadge.Item2
                                </span>
                            </div>

                            @if (unit.ShortfallAmount > 0)
                            {
                                <div class="alert alert-info">
                                    <strong>Shortfall Amount:</strong> $@unit.ShortfallAmount.ToString("N0")
                                    <br/>
                                    <small class="text-muted">(@unit.ShortfallPercentage.ToString("N1")% of purchase price)</small>
                                </div>
                            }
                            else
                            {
                                <div class="alert alert-success">
                                    <i class="bi bi-check-circle me-2"></i>
                                    <strong>No shortfall!</strong> You have sufficient funds to close.
                                </div>
                            }
                        }
                        else
                        {
                            <div class="text-center text-muted py-4">
                                <i class="bi bi-hourglass-split fs-1 mb-3 d-block"></i>
                                <p>Complete your profile to see your closing status and analysis.</p>
                            </div>
                        }

                        <!-- Mortgage Info Summary -->
                        @if (unit.HasMortgageInfo)
                        {
                            <div class="border rounded p-3 mt-3">
                                <h6 class="small text-muted mb-2">MORTGAGE INFO</h6>
                                @if (unit.MortgageApproved)
                                {
                                    <p class="mb-1">
                                        <i class="bi bi-check-circle text-success me-1"></i>
                                        <strong>Approved:</strong> $@unit.MortgageAmount.ToString("N0")
                                    </p>
                                    @if (!string.IsNullOrEmpty(unit.MortgageProvider))
                                    {
                                        <p class="mb-0 small text-muted">via @unit.MortgageProvider</p>
                                    }
                                }
                                else
                                {
                                    <p class="mb-0">
                                        <i class="bi bi-x-circle text-danger me-1"></i>
                                        No mortgage approval on file
                                    </p>
                                }
                                @if (unit.CreditScore.HasValue)
                                {
                                    <p class="mb-0 mt-2 small">
                                        <i class="bi bi-speedometer2 me-1"></i>
                                        Credit Score: <strong class="@(unit.CreditScore >= 700 ? "text-success" : unit.CreditScore >= 600 ? "text-warning" : "text-danger")">@unit.CreditScore</strong>
                                    </p>
                                }
                                @if (!string.IsNullOrEmpty(unit.MortgageComments))
                                {
                                    <p class="mb-0 mt-1 small text-muted fst-italic">@unit.MortgageComments</p>
                                }
                            </div>
                        }

                        <!-- Personal Funds Breakdown -->
                        @if (unit.HasFinancialsSubmitted && (unit.RRSPAvailable > 0 || unit.GiftFromFamily > 0 || unit.ProceedsFromSale > 0 || unit.OtherFundsAmount > 0))
                        {
                            <div class="border rounded p-3 mt-3">
                                <h6 class="small text-muted mb-2">PERSONAL FUNDS</h6>
                                @if (unit.RRSPAvailable > 0)
                                {
                                    <p class="mb-1 small"><i class="bi bi-piggy-bank me-1"></i>RRSP: <strong>$@unit.RRSPAvailable.ToString("N0")</strong></p>
                                }
                                @if (unit.GiftFromFamily > 0)
                                {
                                    <p class="mb-1 small"><i class="bi bi-gift me-1"></i>Gift: <strong>$@unit.GiftFromFamily.ToString("N0")</strong></p>
                                }
                                @if (unit.ProceedsFromSale > 0)
                                {
                                    <p class="mb-1 small"><i class="bi bi-house me-1"></i>Sale Proceeds: <strong>$@unit.ProceedsFromSale.ToString("N0")</strong></p>
                                }
                                @if (unit.OtherFundsAmount > 0)
                                {
                                    <p class="mb-1 small">
                                        <i class="bi bi-cash me-1"></i>Other: <strong>$@unit.OtherFundsAmount.ToString("N0")</strong>
                                        @if (!string.IsNullOrEmpty(unit.OtherFundsDescription))
                                        {
                                            <span class="text-muted">(@unit.OtherFundsDescription)</span>
                                        }
                                    </p>
                                }
                                <hr class="my-2" />
                                <p class="mb-0 small">
                                    <i class="bi bi-wallet2 me-1"></i>Additional Cash: <strong>$@unit.AdditionalCashAvailable.ToString("N0")</strong>
                                </p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Pagination -->
    @if (Model.TotalPages > 1)
    {
        <nav class="mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <small class="text-muted">
                    Showing @(((Model.CurrentPage - 1) * Model.PageSize) + 1)â€“@Math.Min(Model.CurrentPage * Model.PageSize, Model.TotalFilteredUnits) of @Model.TotalFilteredUnits units
                </small>
                <ul class="pagination pagination-sm mb-0">
                    @if (Model.CurrentPage > 1)
                    {
                        <li class="page-item">
                            <a class="page-link" href="@Url.Action("Dashboard", new { page = Model.CurrentPage - 1, pageSize = Model.PageSize, search = Model.SearchQuery })">&laquo;</a>
                        </li>
                    }
                    else
                    {
                        <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
                    }

                    @for (int p = 1; p <= Model.TotalPages; p++)
                    {
                        if (p == 1 || p == Model.TotalPages || (p >= Model.CurrentPage - 2 && p <= Model.CurrentPage + 2))
                        {
                            if (p == Model.CurrentPage)
                            {
                                <li class="page-item active"><span class="page-link">@p</span></li>
                            }
                            else
                            {
                                <li class="page-item">
                                    <a class="page-link" href="@Url.Action("Dashboard", new { page = p, pageSize = Model.PageSize, search = Model.SearchQuery })">@p</a>
                                </li>
                            }
                        }
                        else if (p == 2 && Model.CurrentPage > 4)
                        {
                            <li class="page-item disabled"><span class="page-link">...</span></li>
                        }
                        else if (p == Model.TotalPages - 1 && Model.CurrentPage < Model.TotalPages - 3)
                        {
                            <li class="page-item disabled"><span class="page-link">...</span></li>
                        }
                    }

                    @if (Model.CurrentPage < Model.TotalPages)
                    {
                        <li class="page-item">
                            <a class="page-link" href="@Url.Action("Dashboard", new { page = Model.CurrentPage + 1, pageSize = Model.PageSize, search = Model.SearchQuery })">&raquo;</a>
                        </li>
                    }
                    else
                    {
                        <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
                    }
                </ul>
            </div>
        </nav>
    }

    <!-- Extension Requests History -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white">
            <h5 class="mb-0">
                <i class="bi bi-calendar-range text-primary me-2"></i>Extension Requests History
                @if (Model.AllExtensionRequests.Any())
                {
                    <span class="badge bg-secondary ms-2">@Model.AllExtensionRequests.Count</span>
                }
            </h5>
        </div>
        <div class="card-body">
            @if (Model.AllExtensionRequests.Any())
            {
                <!-- Filter / Search / Sort controls -->
                <div class="row g-2 mb-3 align-items-end">
                    <div class="col-md-3">
                        <label class="form-label small text-muted mb-1">Project</label>
                        <select id="extProjectFilter" class="form-select form-select-sm">
                            <option value="">All Projects</option>
                            @foreach (var prj in Model.Projects)
                            {
                                <option value="@prj.Name">@prj.Name</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small text-muted mb-1">Search Unit</label>
                        <div class="input-group input-group-sm">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text" id="extUnitSearch" class="form-control" placeholder="Unit number..." />
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small text-muted mb-1">Sort By</label>
                        <select id="extSortBy" class="form-select form-select-sm">
                            <option value="date-desc">Newest First</option>
                            <option value="date-asc">Oldest First</option>
                            <option value="unit-asc">Unit (A-Z)</option>
                            <option value="unit-desc">Unit (Z-A)</option>
                            <option value="status-asc">Status (A-Z)</option>
                            <option value="status-desc">Status (Z-A)</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex gap-2">
                        <button type="button" id="extClearFilters" class="btn btn-sm btn-outline-secondary">Clear</button>
                        <span class="text-muted small align-self-center ms-auto" id="extResultCount"></span>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover mb-0 align-middle small" id="extTable">
                        <thead class="table-light">
                            <tr>
                                <th>Project</th>
                                <th>Unit</th>
                                <th>Original Close</th>
                                <th>Requested Close</th>
                                <th>Reason</th>
                                <th>Submitted</th>
                                <th>Status</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody id="extTableBody">
                            @foreach (var ext in Model.AllExtensionRequests)
                            {
                                <tr data-project="@ext.ProjectName" data-unit="@ext.UnitNumber" data-status="@ext.StatusText" data-date="@ext.RequestedDate.ToString("yyyy-MM-dd")">
                                    <td class="text-muted">@ext.ProjectName</td>
                                    <td class="fw-bold">@ext.UnitNumber</td>
                                    <td class="text-muted">
                                        @(ext.OriginalClosingDate?.ToString("MMM dd, yyyy") ?? "â€”")
                                    </td>
                                    <td>@ext.RequestedNewClosingDate.ToString("MMM dd, yyyy")</td>
                                    <td class="text-muted" style="max-width:180px;">@(ext.Reason ?? "â€”")</td>
                                    <td class="text-muted">@ext.RequestedDate.ToString("MMM dd, yyyy")</td>
                                    <td><span class="badge @ext.StatusBadgeClass">@ext.StatusText</span></td>
                                    <td class="text-muted fst-italic" style="max-width:150px;">
                                        @(ext.ReviewerNotes ?? "â€”")
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center py-4 text-muted">
                    <i class="bi bi-calendar-range fs-2 d-block mb-2"></i>
                    <p class="mb-0">No extension requests yet. Use the <strong>Request Closing Extension</strong> button on any unit card above to submit one.</p>
                </div>
            }
        </div>
    </div>

    <!-- Help Card -->
    <div class="card border-0 shadow-sm bg-light">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h5><i class="bi bi-question-circle me-2 text-primary"></i>Need Help?</h5>
                    <p class="mb-0 text-muted">
                        If you have questions about your closing, mortgage requirements, or the Statement of Adjustments, 
                        please contact your builder representative or lawyer.
                    </p>
                </div>
                <div class="col-md-4 text-md-end">
                    <a href="mailto:support@@preconhub.ca" class="btn btn-outline-primary">
                        <i class="bi bi-envelope me-2"></i>Contact Support
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
<style>
    .bg-orange { background-color: #fd7e14 !important; }
</style>
}

@section Scripts {
<script>
    (function () {
        // Live search for unit cards (server-side)
        var timer = null;
        var searchBox = document.getElementById('searchBox');
        if (searchBox) {
            searchBox.addEventListener('input', function () {
                clearTimeout(timer);
                var val = this.value.trim();
                if (val.length >= 2 || val.length === 0) {
                    timer = setTimeout(function () {
                        document.getElementById('filterForm').submit();
                    }, 400);
                }
            });
        }

        // Extension requests table â€” client-side filter/search/sort
        var tbody = document.getElementById('extTableBody');
        if (!tbody) return;

        var projectFilter = document.getElementById('extProjectFilter');
        var unitSearch = document.getElementById('extUnitSearch');
        var sortBy = document.getElementById('extSortBy');
        var clearBtn = document.getElementById('extClearFilters');
        var countEl = document.getElementById('extResultCount');
        var allRows = Array.from(tbody.querySelectorAll('tr'));
        var totalCount = allRows.length;

        function applyFilters() {
            var pVal = projectFilter.value;
            var uVal = unitSearch.value.trim().toLowerCase();
            var visible = [];

            allRows.forEach(function (row) {
                var project = row.getAttribute('data-project');
                var unit = row.getAttribute('data-unit').toLowerCase();
                var show = true;

                if (pVal && project !== pVal) show = false;
                if (uVal && !unit.startsWith(uVal)) show = false;

                row.style.display = show ? '' : 'none';
                if (show) visible.push(row);
            });

            // Sort visible rows
            var sVal = sortBy.value;
            visible.sort(function (a, b) {
                switch (sVal) {
                    case 'unit-asc':
                        return a.getAttribute('data-unit').localeCompare(b.getAttribute('data-unit'), undefined, { numeric: true });
                    case 'unit-desc':
                        return b.getAttribute('data-unit').localeCompare(a.getAttribute('data-unit'), undefined, { numeric: true });
                    case 'status-asc':
                        return a.getAttribute('data-status').localeCompare(b.getAttribute('data-status'));
                    case 'status-desc':
                        return b.getAttribute('data-status').localeCompare(a.getAttribute('data-status'));
                    case 'date-asc':
                        return a.getAttribute('data-date').localeCompare(b.getAttribute('data-date'));
                    case 'date-desc':
                    default:
                        return b.getAttribute('data-date').localeCompare(a.getAttribute('data-date'));
                }
            });

            // Re-order DOM
            visible.forEach(function (row) { tbody.appendChild(row); });
            // Append hidden rows at end
            allRows.forEach(function (row) {
                if (row.style.display === 'none') tbody.appendChild(row);
            });

            countEl.textContent = visible.length < totalCount
                ? visible.length + ' of ' + totalCount
                : totalCount + ' total';
        }

        projectFilter.addEventListener('change', applyFilters);
        unitSearch.addEventListener('input', applyFilters);
        sortBy.addEventListener('change', applyFilters);
        clearBtn.addEventListener('click', function () {
            projectFilter.value = '';
            unitSearch.value = '';
            sortBy.value = 'date-desc';
            applyFilters();
        });

        // Initial count
        applyFilters();
    })();
</script>
}
