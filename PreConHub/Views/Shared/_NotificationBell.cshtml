@* 
    _NotificationBell.cshtml
    
    Add this partial to your _Layout.cshtml navbar area:
    <partial name="_NotificationBell" />
    
    Place it after the main nav items, before the user dropdown
*@

<style>
    .notification-bell {
        position: relative;
        cursor: pointer;
    }
    .notification-badge {
        position: absolute;
        top: -4px;
        right: -4px;
        min-width: 18px;
        height: 18px;
        font-size: 0.65rem;
        font-weight: 600;
        padding: 0 4px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #dc3545;
        color: white;
        animation: pulse-badge 2s infinite;
    }
    .notification-badge.hidden {
        display: none;
    }
    @@keyframes pulse-badge {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
    }
    .notification-dropdown {
        width: 380px;
        max-height: 480px;
        padding: 0;
        border: none;
        box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        border-radius: 12px;
        overflow: hidden;
    }
    .notification-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.25rem;
        background: linear-gradient(135deg, #1a1a2e, #16213e);
        color: white;
    }
    .notification-header h6 {
        margin: 0;
        font-weight: 600;
    }
    .notification-list {
        max-height: 350px;
        overflow-y: auto;
    }
    .notification-item {
        display: flex;
        padding: 1rem 1.25rem;
        border-bottom: 1px solid #f0f0f0;
        text-decoration: none;
        color: inherit;
        transition: background-color 0.15s;
        cursor: pointer;
    }
    .notification-item:hover {
        background-color: #f8f9fa;
    }
    .notification-item.unread {
        background-color: #f0f7ff;
    }
    .notification-item.unread:hover {
        background-color: #e3f0ff;
    }
    .notification-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
        flex-shrink: 0;
    }
    .notification-icon.primary { background: #e3f2fd; color: #1976d2; }
    .notification-icon.success { background: #e8f5e9; color: #388e3c; }
    .notification-icon.warning { background: #fff3e0; color: #f57c00; }
    .notification-icon.danger { background: #ffebee; color: #d32f2f; }
    .notification-icon.purple { background: #f3e5f5; color: #7b1fa2; }
    .notification-icon.secondary { background: #eceff1; color: #546e7a; }
    .notification-icon.orange { background: #fff3e0; color: #e65100; }
    .notification-icon.info { background: #e0f7fa; color: #0097a7; }
    .notification-icon.teal { background: #e0f2f1; color: #00796b; }
    .notification-content {
        flex: 1;
        min-width: 0;
    }
    .notification-title {
        font-weight: 600;
        font-size: 0.9rem;
        margin-bottom: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .notification-message {
        font-size: 0.8rem;
        color: #6c757d;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    .notification-time {
        font-size: 0.7rem;
        color: #adb5bd;
        margin-top: 4px;
    }
    .notification-footer {
        padding: 0.75rem 1.25rem;
        text-align: center;
        background: #f8f9fa;
        border-top: 1px solid #dee2e6;
    }
    .notification-empty {
        padding: 3rem 1.25rem;
        text-align: center;
        color: #6c757d;
    }
    .notification-empty i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
    .mark-all-read {
        font-size: 0.75rem;
        color: rgba(255,255,255,0.8);
        text-decoration: none;
        padding: 4px 8px;
        border-radius: 4px;
        transition: background-color 0.15s;
    }
    .mark-all-read:hover {
        background: rgba(255,255,255,0.1);
        color: white;
    }
    .unread-dot {
        width: 8px;
        height: 8px;
        background: #007bff;
        border-radius: 50%;
        margin-left: 8px;
        flex-shrink: 0;
    }
    .notification-actions {
        display: flex;
        gap: 4px;
        margin-left: 8px;
    }
    .notification-action-btn {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        border: none;
        background: transparent;
        color: #6c757d;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.15s;
    }
    .notification-action-btn:hover {
        background: #e9ecef;
        color: #495057;
    }
    .notification-skeleton {
        padding: 1rem 1.25rem;
        display: flex;
        align-items: center;
    }
    .skeleton {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: skeleton-loading 1.5s infinite;
        border-radius: 4px;
    }
    @@keyframes skeleton-loading {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }
</style>

<!-- Notification Bell in Navbar -->
<li class="nav-item dropdown me-2">
    <a class="nav-link notification-bell" href="#" id="notificationDropdown" role="button" 
       data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside">
        <i class="bi bi-bell" style="font-size: 1.2rem;"></i>
        <span class="notification-badge hidden" id="notificationBadge">0</span>
    </a>
    <div class="dropdown-menu dropdown-menu-end notification-dropdown" aria-labelledby="notificationDropdown">
        <!-- Header -->
        <div class="notification-header">
            <h6><i class="bi bi-bell me-2"></i>Notifications</h6>
            <a href="#" class="mark-all-read" onclick="markAllNotificationsRead(); return false;">
                <i class="bi bi-check-all me-1"></i>Mark all read
            </a>
        </div>
        
        <!-- Notification List -->
        <div class="notification-list" id="notificationList">
            <!-- Loading skeleton -->
            <div class="notification-skeleton" id="notificationSkeleton">
                <div class="skeleton" style="width: 40px; height: 40px; border-radius: 50%; margin-right: 12px;"></div>
                <div style="flex: 1;">
                    <div class="skeleton" style="width: 60%; height: 14px; margin-bottom: 8px;"></div>
                    <div class="skeleton" style="width: 90%; height: 12px;"></div>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="notification-footer">
            <a href="/Notifications" class="text-primary text-decoration-none">
                <i class="bi bi-list me-1"></i>View All Notifications
            </a>
        </div>
    </div>
</li>

<script>
// Notification system
const NotificationSystem = {
    pollInterval: null,
    
    init() {
        this.loadNotifications();
        this.startPolling();
        
        // Stop polling when dropdown opens (will reload on close)
        document.getElementById('notificationDropdown')?.addEventListener('show.bs.dropdown', () => {
            this.loadNotifications();
        });
    },
    
    startPolling() {
        // Poll every 30 seconds for new notifications
        this.pollInterval = setInterval(() => this.updateBadge(), 30000);
    },
    
    async loadNotifications() {
        try {
            const response = await fetch('/api/NotificationsApi?count=10');
            if (!response.ok) return;
            
            const data = await response.json();
            this.renderNotifications(data.notifications);
            this.updateBadgeCount(data.unreadCount);
        } catch (error) {
            console.error('Failed to load notifications:', error);
        }
    },
    
    async updateBadge() {
        try {
            const response = await fetch('/api/NotificationsApi/count');
            if (!response.ok) return;
            
            const data = await response.json();
            this.updateBadgeCount(data.count);
        } catch (error) {
            console.error('Failed to update badge:', error);
        }
    },
    
    updateBadgeCount(count) {
        const badge = document.getElementById('notificationBadge');
        if (!badge) return;
        
        if (count > 0) {
            badge.textContent = count > 99 ? '99+' : count;
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }
    },
    
    renderNotifications(notifications) {
        const list = document.getElementById('notificationList');
        if (!list) return;
        
        if (!notifications || notifications.length === 0) {
            list.innerHTML = `
                <div class="notification-empty">
                    <i class="bi bi-bell-slash"></i>
                    <p class="mb-0">No notifications yet</p>
                    <small class="text-muted">We'll notify you when something important happens</small>
                </div>
            `;
            return;
        }
        
        list.innerHTML = notifications.map(n => `
            <div class="notification-item ${n.isRead ? '' : 'unread'}" data-id="${n.id}" onclick="NotificationSystem.openNotification(${n.id}, '${n.actionUrl || ''}')">
                <div class="notification-icon ${n.typeColor}">
                    <i class="bi ${n.typeIcon}"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">${this.escapeHtml(n.title)}</div>
                    <div class="notification-message">${this.escapeHtml(n.message)}</div>
                    <div class="notification-time">${n.timeAgo}</div>
                </div>
                ${!n.isRead ? '<div class="unread-dot"></div>' : ''}
                <div class="notification-actions" onclick="event.stopPropagation();">
                    ${!n.isRead ? `
                        <button class="notification-action-btn" onclick="NotificationSystem.markAsRead(${n.id})" title="Mark as read">
                            <i class="bi bi-check"></i>
                        </button>
                    ` : ''}
                    <button class="notification-action-btn" onclick="NotificationSystem.deleteNotification(${n.id})" title="Delete">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            </div>
        `).join('');
    },
    
    async openNotification(id, actionUrl) {
        // Mark as read
        await this.markAsRead(id);
        
        // Navigate to action URL if provided
        if (actionUrl) {
            window.location.href = actionUrl;
        }
    },
    
    async markAsRead(id) {
        try {
            const response = await fetch(`/api/NotificationsApi/${id}/read`, { method: 'POST' });
            if (!response.ok) return;
            
            const data = await response.json();
            this.updateBadgeCount(data.unreadCount);
            
            // Update UI
            const item = document.querySelector(`.notification-item[data-id="${id}"]`);
            if (item) {
                item.classList.remove('unread');
                const dot = item.querySelector('.unread-dot');
                if (dot) dot.remove();
                const readBtn = item.querySelector('.notification-action-btn');
                if (readBtn && readBtn.querySelector('.bi-check')) readBtn.remove();
            }
        } catch (error) {
            console.error('Failed to mark as read:', error);
        }
    },
    
    async deleteNotification(id) {
        try {
            const response = await fetch(`/api/NotificationsApi/${id}`, { method: 'DELETE' });
            if (!response.ok) return;
            
            const data = await response.json();
            this.updateBadgeCount(data.unreadCount);
            
            // Remove from UI with animation
            const item = document.querySelector(`.notification-item[data-id="${id}"]`);
            if (item) {
                item.style.opacity = '0';
                item.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    item.remove();
                    // Check if list is empty
                    const list = document.getElementById('notificationList');
                    if (list && !list.querySelector('.notification-item')) {
                        this.renderNotifications([]);
                    }
                }, 200);
            }
        } catch (error) {
            console.error('Failed to delete notification:', error);
        }
    },
    
    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
};

// Mark all as read
async function markAllNotificationsRead() {
    try {
        const response = await fetch('/api/NotificationsApi/read-all', { method: 'POST' });
        if (!response.ok) return;
        
        NotificationSystem.updateBadgeCount(0);
        
        // Update UI - remove all unread indicators
        document.querySelectorAll('.notification-item.unread').forEach(item => {
            item.classList.remove('unread');
            const dot = item.querySelector('.unread-dot');
            if (dot) dot.remove();
        });
    } catch (error) {
        console.error('Failed to mark all as read:', error);
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    NotificationSystem.init();
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/notificationHub")
            .withAutomaticReconnect()
            .build();

        connection.on("ReceiveNotification", (notification) => {
            NotificationSystem.loadNotifications();
            // Optional: Show toast notification
            showToast(notification.title, notification.message);
        });

        connection.on("UpdateNotificationCount", (count) => {
            NotificationSystem.updateBadgeCount(count);
        });

        connection.start().catch(err => console.error("SignalR Error:", err));

});


        (function () {
      if (window.__notifBellInit) return;
        window.__notifBellInit = true;

        // 1) Polling (every 30s)
        async function refreshBell() {
        try {
            await updateUnreadCount();
        await loadNotifications();
        } catch (e) {
            console.error("Notification refresh failed:", e);
        }
      }

        setInterval(refreshBell, 30000);

        // 2) SignalR (real-time)
        if (window.signalR) {
        const connection = new signalR.HubConnectionBuilder()
        .withUrl("/notificationHub")
        .withAutomaticReconnect()
        .build();

        connection.on("ReceiveNotification", function () {
            refreshBell();
        });

        connection.on("UpdateNotificationCount", function () {
            updateUnreadCount();
        });

        connection.start().catch(err => console.error(err));
      }
    })();


</script>
